version: 1

entities:
  hrm.employee:
    meta:
      titleSingular: Employee
      titlePlural: Employees
      descriptionPlural: HRM employee directory
      routes:
        root: /hrm
        list: /hrm/employees
        detail: /hrm/employees/{id}
        edit: /hrm/employees/{id}/edit
      breadcrumbs:
        - { label: HRM, href: /hrm }
        - { label: Employees, href: /hrm/employees }
      actions:
        editLabel: Edit Employee
        saveUpdateLabel: Save
        cancelLabel: Cancel
        allowCreate: false
        allowDelete: false
      headerActions:
        - kind: action
          actionKey: hrm.employees.sync
          label: Sync Employees
          icon: refresh
          listOnly: true
          confirm:
            title: Sync employees?
            body: This will sync HRM employees with auth users and update active status.

    # Schema-driven page security (source of truth for EntityList/Detail/New/Edit pages).
    # This is used by route generation to populate routes-meta.ts authz/roles.
    security:
      list:
        roles: []
        default_roles_allow: [admin]
        authz: { entity: employees, verb: read, require_action: hrm.employees.access, show_pages: true }
      detail:
        roles: []
        default_roles_allow: [admin]
        authz: { entity: employees, verb: read, require_action: hrm.employees.detail.access, show_pages: true }
      edit:
        roles: []
        default_roles_allow: [admin]
        authz: { entity: employees, verb: write, require_action: hrm.employees.edit.access, show_pages: true }

    api:
      baseUrl: /api/hrm/employees

    storage:
      # Drizzle table export name (re-exported by the host app's lib/schema.ts)
      drizzleTable: employees

    list:
      tableId: hrm.employees
      uiStateVersion: 2
      pageSize: 25
      initialSort:
        sortBy: name
        sortOrder: asc
      sortWhitelist:
        - name
        - userEmail
        - firstName
        - lastName
        - positionName
        - preferredName
        - jobLevel
        - hireDate
        - phone
        - city
        - state
        - country
        - createdAt
        - updatedAt
      initialColumnVisibility:
        profilePictureUrl: true
        name: true
        firstName: false
        lastName: false
        positionName: true
        phone: false
        city: false
        state: false
        country: false
        isActive: false
        # LDD columns - hidden by default, can be enabled via Columns menu
        divisionName: false
        departmentName: false
        locationName: false
        createdAt: false
        updatedAt: false
      columns:
        - key: profilePictureUrl
          label: Photo
          sortable: false
          hideable: true
          align: center
          width: 64px
          platforms: [web]
        - name
        - userEmail
        - preferredName
        - firstName
        - lastName
        - positionName
        - jobLevel
        - hireDate
        - isActive
        - phone
        - city
        - state
        - country
        - divisionName
        - departmentName
        - locationName
        - createdAt
        - updatedAt

    form:
      sections:
        - id: photo
          title: Photo
          layout: { columns: 1 }
          fields: [profilePictureUrl]
        - id: basics
          title: Basics
          layout: { columns: 2 }
          fields: [userEmail, firstName, lastName, preferredName, positionId, jobLevel, hireDate, managerId, phone]
        - id: address
          title: Address
          layout: { columns: 2 }
          fields: [address1, address2, city, state, postalCode, country]
        - id: org-scope
          title: Org Scope
          widget: orgAssignment
          platforms: [web, mobile]

    fields:
      id: { type: text, label: ID }
      # Computed/display convenience field (not a physical column).
      # Use firstName/lastName for persistence.
      name:
        type: text
        label: Name
        virtual: true
        compute:
          kind: concat
          fields: [firstName, lastName]
          separator: " "
      userEmail: { type: email, label: User Email, readOnly: true }
      profilePictureUrl:
        type: image
        label: Photo
        widget: profilePhoto
        widgetConfig:
          allowDelete: true
          maxSizeMB: 5
      firstName: { type: text, label: First Name, required: true }
      lastName: { type: text, label: Last Name, required: true }
      preferredName: { type: text, label: Preferred Name }
      positionId:
        type: select
        label: Position
        optionSource: hrm.positions
        labelFromRow: positionName
      positionName:
        type: text
        label: Position
        virtual: true
        compute:
          kind: labelFrom
          sourceField: positionId
      jobLevel: { type: number, label: Job Level }
      hireDate: { type: date, label: Hire Date }
      divisionId:
        type: select
        label: Division
        optionSource: org.divisions
        virtual: true
        compute:
          kind: join
          joins:
            - entity: org.userOrgAssignment
              localField: userEmail
              foreignField: userKey
            - entity: org.division
              localField: divisionId
              foreignField: id
          groupField: id
          labelField: name
      departmentId:
        type: select
        label: Department
        optionSource: org.departments
        virtual: true
        compute:
          kind: join
          joins:
            - entity: org.userOrgAssignment
              localField: userEmail
              foreignField: userKey
            - entity: org.department
              localField: departmentId
              foreignField: id
          groupField: id
          labelField: name
      locationId:
        type: select
        label: Location
        optionSource: org.locations
        virtual: true
        compute:
          kind: join
          joins:
            - entity: org.userOrgAssignment
              localField: userEmail
              foreignField: userKey
            - entity: org.location
              localField: locationId
              foreignField: id
          groupField: id
          labelField: name
      managerId:
        type: reference
        label: Manager
        reference:
          entityType: hrm.employee
          pickerEndpoint: /api/hrm/employees/picker
          valueField: id
          labelField: displayName
          labelFromRow: managerName
      managerName:
        type: text
        label: Manager
        virtual: true
        compute:
          kind: labelFrom
          sourceField: managerId
      isActive: { type: boolean, label: Active, default: true }
      phone: { type: phone, label: Phone }
      address1: { type: text, label: Address Line 1 }
      address2: { type: text, label: Address Line 2 }
      city: { type: text, label: City }
      state: { type: text, label: State/Province }
      postalCode: { type: text, label: Postal Code }
      country: { type: text, label: Country }
      divisionName:
        type: text
        label: Division
        virtual: true
        compute:
          kind: join
          joins:
            - entity: org.userOrgAssignment
              localField: userEmail
              foreignField: userKey
            - entity: org.division
              localField: divisionId
              foreignField: id
          groupField: id
          labelField: name
      departmentName:
        type: text
        label: Department
        virtual: true
        compute:
          kind: join
          joins:
            - entity: org.userOrgAssignment
              localField: userEmail
              foreignField: userKey
            - entity: org.department
              localField: departmentId
              foreignField: id
          groupField: id
          labelField: name
      locationName:
        type: text
        label: Location
        virtual: true
        compute:
          kind: join
          joins:
            - entity: org.userOrgAssignment
              localField: userEmail
              foreignField: userKey
            - entity: org.location
              localField: locationId
              foreignField: id
          groupField: id
          labelField: name
      createdAt: { type: datetime, label: Created }
      updatedAt: { type: datetime, label: Updated }

    detail:
      summaryTitle: Details
      summaryFields:
        - profilePictureUrl
        - userEmail
        - preferredName
        - firstName
        - lastName
        - positionName
        - jobLevel
        - hireDate
        - managerName
        - phone
        - address1
        - address2
        - city
        - state
        - postalCode
        - country
        - divisionName
        - departmentName
        - locationName
        - createdAt
        - updatedAt
      extras:
        - kind: tabs
          tabs:
            - id: list
              label: Direct Reports
              platforms: [web, mobile]
              content:
                kind: embeddedTable
                title: Direct Reports
                entityType: hrm.employee
                query:
                  managerId:
                    valueFrom:
                      kind: parentField
                      field: id
            - id: chart
              label: Org Chart
              platforms: [web, mobile]
              content:
                kind: orgChart
                endpoint: /api/hrm/employees/{id}/direct-reports
                navigateTo: /hrm/employees/{id}
                variant: compact
                employeeIdFrom:
                  kind: parentField
                  field: id
