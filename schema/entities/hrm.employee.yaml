version: 1

entities:
  hrm.employee:
    meta:
      titleSingular: Employee
      titlePlural: Employees
      descriptionPlural: HRM employee directory
      routes:
        root: /hrm
        list: /hrm/employees
        detail: /hrm/employees/{id}
        edit: /hrm/employees/{id}/edit
      breadcrumbs:
        - { label: HRM, href: /hrm }
        - { label: Employees, href: /hrm/employees }
      actions:
        editLabel: Edit Employee
        saveUpdateLabel: Save
        cancelLabel: Cancel
        allowCreate: false
      headerActions:
        - kind: action
          actionKey: hrm.employees.sync
          label: Sync Employees
          confirm:
            title: Sync employees?
            body: This will sync HRM employees with auth users and update active status.

    # Schema-driven page security (source of truth for EntityList/Detail/New/Edit pages).
    # This is used by route generation to populate routes-meta.ts authz/roles.
    security:
      list:
        roles: []
        default_roles_allow: [admin]
        authz: { entity: employees, verb: read, require_action: hrm.employees.access, show_pages: true }
      detail:
        roles: []
        default_roles_allow: [admin]
        authz: { entity: employees, verb: read, require_action: hrm.employees.detail.access, show_pages: true }
      new:
        roles: []
        default_roles_allow: [admin]
        authz: { entity: employees, verb: write, require_action: hrm.employees.create.access, require_create: true, show_pages: true }
      edit:
        roles: []
        default_roles_allow: [admin]
        authz: { entity: employees, verb: write, require_action: hrm.employees.edit.access, show_pages: true }

    api:
      resource: employees

    storage:
      # Drizzle table export name (re-exported by the host app's lib/schema.ts)
      drizzleTable: employees

    list:
      tableId: hrm.employees
      uiStateVersion: 1
      pageSize: 25
      initialSort:
        sortBy: name
        sortOrder: asc
      sortWhitelist:
        - name
        - userEmail
        - firstName
        - lastName
        - positionName
        - preferredName
        - phone
        - city
        - state
        - country
        - createdAt
        - updatedAt
      initialColumnVisibility:
        name: true
        firstName: false
        lastName: false
        positionName: true
        phone: false
        city: false
        state: false
        country: false
        isActive: false
        createdAt: false
        updatedAt: false
      columns:
        - name
        - userEmail
        - preferredName
        - firstName
        - lastName
        - positionName
        - isActive
        - phone
        - city
        - state
        - country
        - createdAt
        - updatedAt

    form:
      sections:
        - id: basics
          title: Basics
          layout: { columns: 2 }
          fields: [userEmail, firstName, lastName, preferredName, positionId, managerId, phone]
        - id: address
          title: Address
          layout: { columns: 2 }
          fields: [address1, address2, city, state, postalCode, country]
        - id: org-scope
          title: Org Scope
          widget: orgAssignment
          platforms: [web, mobile]

    fields:
      id: { type: text, label: ID }
      # Computed/display convenience field (not a physical column).
      # Use firstName/lastName for persistence.
      name: { type: text, label: Name, virtual: true }
      userEmail: { type: email, label: User Email, readOnly: true }
      firstName: { type: text, label: First Name, required: true }
      lastName: { type: text, label: Last Name, required: true }
      preferredName: { type: text, label: Preferred Name }
      positionId:
        type: select
        label: Position
        optionSource: hrm.positions
        labelFromRow: positionName
      positionName: { type: text, label: Position, virtual: true }
      divisionId:
        type: select
        label: Division
        optionSource: org.divisions
        virtual: true
      departmentId:
        type: select
        label: Department
        optionSource: org.departments
        virtual: true
      locationId:
        type: select
        label: Location
        optionSource: org.locations
        virtual: true
      managerId:
        type: reference
        label: Manager
        reference:
          entityType: hrm.employee
          pickerEndpoint: /api/hrm/employees/picker
          valueField: id
          labelField: displayName
          labelFromRow: managerName
      managerName: { type: text, label: Manager, virtual: true }
      isActive: { type: boolean, label: Active, default: true }
      phone: { type: phone, label: Phone }
      address1: { type: text, label: Address Line 1 }
      address2: { type: text, label: Address Line 2 }
      city: { type: text, label: City }
      state: { type: text, label: State/Province }
      postalCode: { type: text, label: Postal Code }
      country: { type: text, label: Country }
      divisionName: { type: text, label: Division, virtual: true }
      departmentName: { type: text, label: Department, virtual: true }
      locationName: { type: text, label: Location, virtual: true }
      createdAt: { type: datetime, label: Created }
      updatedAt: { type: datetime, label: Updated }

    detail:
      summaryTitle: Details
      summaryFields:
        - userEmail
        - preferredName
        - firstName
        - lastName
        - positionName
        - managerId
        - phone
        - address1
        - address2
        - city
        - state
        - postalCode
        - country
        - divisionName
        - departmentName
        - locationName
        - createdAt
        - updatedAt
      extras:
        - kind: tabs
          tabs:
            - id: list
              label: Direct Reports
              platforms: [web, mobile]
              content:
                kind: embeddedTable
                title: Direct Reports
                entityType: hrm.employee
                query:
                  managerId:
                    valueFrom:
                      kind: parentField
                      field: id
            - id: chart
              label: Org Chart
              platforms: [web]
              content:
                kind: orgChart
                employeeIdFrom:
                  kind: parentField
                  field: id
